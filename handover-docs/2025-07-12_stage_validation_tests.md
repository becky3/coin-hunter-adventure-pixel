# 2025-07-12 ステージデータ検証テストの実装

## 概要

Issue #123 に対応し、ステージデータの妥当性を検証するE2Eテストを実装しました。

## 実装内容

### 1. ステージ検証テスト（test-stage-validation.cjs）

以下の項目をチェックする包括的なテストを作成：
- コインがブロックに埋まっていないか
- エンティティ（敵など）がブロックに埋まっていないか
- エンティティが浮いていないか
- アイテムが取得可能な高さにあるか
- プレイヤースポーン位置が適切か
- ゴール位置が適切か

#### 座標系の問題

EntityManagerには座標系の不整合があることを発見：
- エンティティのY座標は底部基準（0が一番下）
- タイルマップの配列は上部基準（0が一番上）
- EntityManagerはこの変換を行わずに直接Y座標を配列インデックスとして使用（バグ）

テストでは、実際のゲーム動作に合わせるため、同じ間違った座標系を使用しています。

### 2. ステージデータの修正

#### stage1-2
- x=66,67,68 のコインがブロックに埋まっていた問題を修正
- x=111,112 のコインがブロックに埋まっていた問題を修正
- x=170,171,172 のコインがブロックに埋まっていた問題を修正

#### stage1-3
- 穴の幅を3タイルから5～8タイルに拡張
  - 1つ目: 6タイル（x=18-23）
  - 2つ目: 7タイル（x=39-45）
  - 3つ目: 5タイル（x=59-63）
  - 4つ目: 8タイル（x=107-114）
  - 5つ目: 6タイル（x=146-151）
- 穴に落ちていたコインを安全な位置に移動
- 最下層の一つ上の列も同じように穴を開けて、正しく落下できるように調整

### 3. テスト専用ステージ（stage0-4）

座標系の問題を検証するために作成したテスト専用ステージ。
本番環境には含まれません（bundledData.ts、stages.json には未登録）。

## テスト結果の分類

- **🔴 Critical（クリティカル）**: ゲームプレイに支障がある問題
  - コインがブロックに埋まっている
  - エンティティがブロックに埋まっている
  - プレイヤースポーン位置が不適切
  - ゴール位置が不適切

- **🟡 Warning（警告）**: プレイ可能だが改善が推奨される問題
  - 高すぎるアイテム（7タイル以上）
  - 浮いている敵

- **🔵 Info（情報）**: 軽微な問題
  - やや高いアイテム（5-6タイル）

## 今後の課題

1. **座標系の統一**: EntityManagerの座標変換バグを修正し、一貫した座標系を使用すべき
2. **穴の幅チェック**: アスレチックステージなど複雑な地形では適切な判定が困難なため、現在は無効化
3. **警告レベルの問題**: 浮いている敵や高すぎるアイテムの調整

## 学んだこと

- 実装とドキュメントの不一致を発見する重要性
- テストを書くことで実装のバグを発見できる
- ゲームの実際の動作に合わせたテストの必要性
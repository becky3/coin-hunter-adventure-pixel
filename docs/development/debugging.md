# デバッグ機能

このドキュメントでは、coin-hunter-adventure-pixelで利用可能なデバッグ機能について説明します。

## デバッグモードの概要

デバッグモードを有効にすると、以下の機能が利用できます：

1. **DebugOverlay** - 画面左上にFPS、プレイヤー座標、ステージ選択などの情報を表示
2. **エンティティのデバッグ表示** - 敵の体力バー、当たり判定の可視化など
3. **パフォーマンス詳細** - 描画呼び出し回数、フレーム時間などの詳細情報

## デバッグモードの有効化

### 方法1: URLパラメータ（推奨）

ゲームのURLに`?debug=true`を追加してアクセスします：

```
http://localhost:3000/?debug=true
```

この方法では、ゲーム起動時からデバッグモードが有効になります。

### 方法2: F3キーでの切り替え

ゲーム実行中にF3キーを押すことで、デバッグモードのON/OFFを切り替えることができます。

- **F3**: DebugOverlayの表示/非表示とエンティティのデバッグ表示を同時に切り替え

### 方法3: ブラウザコンソール

開発者ツールのコンソールから手動で設定することも可能です：

```javascript
// デバッグモードを有効化
game.renderer.setDebugMode(true)

// デバッグモードを無効化
game.renderer.setDebugMode(false)
```

## DebugOverlayの機能

DebugOverlayが表示されているときは、以下のキーボードショートカットが利用できます：

| キー | 機能 |
|------|------|
| F3 | DebugOverlayとデバッグ表示の切り替え |
| + / - | ゲームスピードの調整 |
| 0 | ゲームスピードをリセット（1.0x） |
| D | ステージ選択モードの切り替え |
| ← → | ステージ選択（Dキーでモードを有効にした後） |
| O | 敵スポーンダイアログを開く |
| P | パフォーマンス詳細表示の切り替え |

### 表示される情報

- **FPS**: 現在のフレームレート
- **Speed**: ゲームスピード倍率
- **Player X/Y**: プレイヤーの現在座標
- **Frame Time**: 1フレームの処理時間
- **Draw Calls**: 描画呼び出し回数

## エンティティのデバッグ表示

`renderer.debug`がtrueの場合、以下の追加情報が表示されます：

### 敵キャラクター
- 体力バー（現在HP/最大HP）
- エンティティ名と状態（G: 接地中、A: 空中）

### プレイヤー
- ジャンプの最高到達点マーカー
- 現在の状態情報
- 座標と速度情報

### その他
- 当たり判定ボックスの可視化（実装により異なる）
- デバッグ用のテキスト情報

## ステージ選択機能

DebugOverlayが有効な状態で：

1. **D**キーを押してステージ選択モードを有効化
2. **←**/**→**キーでステージを選択
3. ゲームを再起動すると選択したステージから開始

または、URLパラメータで直接ステージを指定：

```
http://localhost:3000/?s=stage1-2&skip_title=true&debug=true
```

## 敵スポーン機能

DebugOverlayが有効な状態で**O**キーを押すと、敵スポーンダイアログが開きます：

1. スポーンしたい敵の種類を選択
2. 「Spawn」ボタンをクリック
3. プレイヤーの現在位置に敵が出現

利用可能な敵の種類：
- slime
- bat
- spider
- armor_knight

## パフォーマンスモニター

**P**キーでパフォーマンス詳細表示を切り替えることができます。以下の情報が追加表示されます：

- 各描画タイプ（sprite、rect、textなど）の呼び出し回数
- キャッシュヒット率
- 詳細なフレーム時間の内訳

## 注意事項

- デバッグ表示は開発時のみ使用することを推奨します
- production環境ではLogger出力が自動的に無効化されます
- デバッグ表示が有効な場合、パフォーマンスに若干の影響があります

## トラブルシューティング

### DebugOverlayが表示されない

1. F3キーが他のアプリケーションで使用されていないか確認
2. ブラウザのコンソールでエラーが出ていないか確認
3. `window.debugOverlay`が存在するか確認

### エンティティのデバッグ表示が出ない

1. `game.renderer.debug`がtrueになっているか確認
2. F3キーでDebugOverlayと同期して切り替わることを確認

### ステージ選択が機能しない

1. DebugOverlayが表示されている状態でDキーを押す
2. ステージリストが`stages.json`に正しく定義されているか確認

## スプライトデバッグページ

### 概要

`sprite-debug.html`は、ゲーム内の全スプライトパターンとパレット情報を一覧表示するデバッグツールです。

### アクセス方法

開発サーバー起動後、以下のURLにアクセス：

```
http://localhost:3000/sprite-debug.html
```

### 主な機能

#### 1. 全スプライトパターンの表示
- **カテゴリ別表示**: player, enemies, items, terrain, environment, tiles, ui, powerups, projectiles, effects
- **3倍拡大表示**: ゲーム内と同じスケールで表示
- **固定サイズ枠**: 90x90pxの枠内に収めて見やすく配置

#### 2. ステージパレット切り替え
- 右上のドロップダウンで以下のパレットを切り替え可能：
  - GRASSLAND（草原ステージ）
  - CAVE（洞窟ステージ）

#### 3. パレット情報の表示
- **パレットインデックス**: 各スプライトの下に「P0」「P1」などの形式で表示
- **カラーパレット**: 使用している4色をカラーボックスで可視化
- **詳細情報**: カラーボックスにホバーするとインデックスとカラーコードを表示

#### 4. 特殊な表示
- **PLAYER (POWER)**: パワーアップ状態のプレイヤーを別パレットで表示
- **敵キャラクター分類**:
  - enemies/slime, enemies/bird: ENEMY_BASIC パレット
  - enemies/bat, enemies/spider, enemies/armor_knight: ENEMY_SPECIAL パレット

### 技術的な実装

#### パレット情報の取得
実際のエンティティクラスから直接パレット情報を取得：

```javascript
// ResourceLoaderを初期化
const resourceLoader = ResourceLoader.getInstance();
await resourceLoader.initialize();
await resourceLoader.preloadEntityConfigs();

// エンティティインスタンスからパレット取得
const player = new Player(0, 0);
const paletteIndex = player.getSpritePaletteIndex();
```

#### エンティティクラスが存在しないスプライト
以下のスプライトはエンティティクラスが存在しないため、直接パレットインデックスを指定：
- **environment**: 背景装飾用（cloud, tree）
- **tiles**: タイル描画用（ground, spike）
- **ui**: UI要素（heart）
- **effects**: エフェクト表示用（shield）

### 使用例

1. 新しいスプライトを追加した際の色確認
2. ステージごとのパレット変化の確認
3. パレット設定のデバッグ
4. スプライトアセットの一覧確認